<% content_for :title, t("audits.index.title") %>

<div class="min-h-full bg-gray-50 dark:bg-gray-900">
  <%= render 'shared/navbar' %>

  <% if flash[:alert] || flash[:notice] %>
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 pt-4">
      <%= render 'shared/flash_messages' %>
    </div>
  <% end %>

  <div class="py-6">
    <main>
      <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white"><%= t("audits.index.title") %></h1>
      <% if @filtered_team %>
        <p class="text-gray-600 dark:text-gray-400 mt-1">
          Filtered by team:
          <%= link_to @filtered_team.name, team_path(@filtered_team), class: "text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300" %>
          • <%= link_to "Show all audits", audits_path, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm" %>
        </p>
      <% end %>
    </div>
    <%= render Auth::LinkButtonComponent.new(text: t("audits.index.new_button"), url: new_audit_path, variant: :primary) %>
  </div>

  <!-- Organizations Overview -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <% @organizations.each do |org| %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <img class="h-10 w-10 rounded-full" src="https://github.com/<%= org.github_login %>.png" alt="<%= org.name %>">
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white"><%= org.name %></h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">@<%= org.github_login %></p>
          </div>
        </div>
        <div class="mt-4">
          <div class="text-sm text-gray-600 dark:text-gray-300">
            <span class="font-medium"><%= org.teams.count %></span> teams
            •
            <span class="font-medium"><%= org.audit_sessions.count %></span> audits
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Recent Audit Sessions -->
  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
    <div class="flow-root">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead>
          <tr>
            <th class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider sm:pl-6">
              Audit Session
            </th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Team
            </th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Status
            </th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Progress
            </th>
            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Started
            </th>
            <th class="px-3 py-3.5 pr-4 sm:pr-6 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Due Date
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          <% @audit_sessions.each do |session| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="py-4 pr-3 pl-4 text-sm font-medium whitespace-nowrap sm:pl-6">
                <div class="text-sm font-medium text-gray-900 dark:text-white">
                  <%= link_to session.name, audit_path(session), class: "text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300" %>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400"><%= session.organization.name %></div>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap">
                <div class="text-sm text-gray-900 dark:text-white"><%= session.team.name %></div>
                <div class="text-sm text-gray-500 dark:text-gray-400">@<%= session.team.github_slug %></div>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                  <%= case session.status
                      when 'active' then 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200'
                      when 'completed' then 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200'
                      when 'draft' then 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200'
                      else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                      end %>">
                  <%= session.status.capitalize %>
                </span>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                    <div class="bg-emerald-600 dark:bg-emerald-500 h-2 rounded-full" style="width: <%= session.progress_percentage %>%"></div>
                  </div>
                  <span class="text-sm text-gray-600 dark:text-gray-300"><%= session.progress_percentage.round %>%</span>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  <%= t("audits.index.member", count: session.audit_members.count) %>
                </div>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dark:text-gray-400">
                <%= session.started_at&.strftime('%b %d, %Y') %>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 pr-4 sm:pr-6">
                <% if session.due_date %>
                  <% days_until_due = (session.due_date - Date.current).to_i %>
                  <% if days_until_due < 0 %>
                    <span class="text-red-600 dark:text-red-400 font-medium"><%= t("audits.index.due_date.overdue", count: -days_until_due) %></span>
                  <% elsif days_until_due == 0 %>
                    <span class="text-yellow-600 dark:text-yellow-400 font-medium"><%= t("audits.index.due_date.due_today") %></span>
                  <% elsif days_until_due <= 7 %>
                    <span class="text-yellow-600 dark:text-yellow-400 font-medium"><%= t("audits.index.due_date.due_soon", count: days_until_due) %></span>
                  <% else %>
                    <%= session.due_date.strftime('%b %d, %Y') %>
                  <% end %>
                <% else %>
                  <span class="text-gray-400 dark:text-gray-500"><%= t("audits.index.due_date.no_due_date") %></span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
          </table>
        </div>
      </div>
    </div>

    <% if @audit_sessions.empty? %>
      <div class="text-center py-12">
        <!-- Heroicons: shield-check -->
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" data-slot="icon">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white"><%= t("audits.index.empty_state.title") %></h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400"><%= t("audits.index.empty_state.message") %></p>
      </div>
    <% end %>
      </div>
    </main>
  </div>
</div>
