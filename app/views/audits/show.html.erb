<% content_for :title, @audit_session.name %>

<div class="min-h-full bg-gray-50 dark:bg-gray-900">
  <%= render 'shared/navbar' %>

  <% if flash[:alert] || flash[:notice] || flash[:success] %>
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 pt-4">
      <%= render 'shared/flash_messages' %>
    </div>
  <% end %>

  <div class="py-6">
    <main id="main-content">
      <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex flex-col space-y-4 lg:flex-row lg:items-start lg:justify-between lg:space-y-0">
      <div class="flex-1">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"><%= @audit_session.name %></h1>
        <div class="flex items-center mt-2 text-gray-600 dark:text-gray-400">
          <%= link_to @audit_session.organization.github_url, target: "_blank", "aria-label": t('accessibility.view_on_github', name: @audit_session.organization.name), class: "inline-block" do %>
            <img class="h-5 w-5 rounded-full mr-2" src="https://github.com/<%= @audit_session.organization.github_login %>.png" alt="<%= @audit_session.organization.name %>" title="<%= @audit_session.organization.name %>">
          <% end %>
          <%= link_to team_path(@audit_session.team), class: "font-medium text-blue-800 dark:text-blue-600 hover:text-blue-700 dark:hover:text-blue-500 inline-flex items-center" do %>
            <%= @audit_session.team.name %>
            <svg class="h-3 w-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          <% end %>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <%= render DueDateDropdownComponent.new(
          audit_session: @audit_session,
          class: "flex-shrink-0"
        ) %>
        <%
          # Define all possible status transitions
          current_status = @audit_session.status
          status_items = []

          # Add all status options except the current one
          unless current_status == 'draft'
            status_items << {
              type: :form,
              text: t('actions.mark_draft'),
              url: toggle_status_audit_path(@audit_session),
              method: :patch,
              data: { turbo_method: :patch, turbo_frame: "_top" },
              icon_path: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />',
              hidden_field: { name: 'status', value: 'draft' },
              hover_color: 'secondary'
            }
          end

          unless current_status == 'active'
            status_items << {
              type: :form,
              text: t('actions.mark_active'),
              url: toggle_status_audit_path(@audit_session),
              method: :patch,
              data: { turbo_method: :patch, turbo_frame: "_top" },
              icon_path: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />',
              hidden_field: { name: 'status', value: 'active' },
              hover_color: 'primary'
            }
          end

          unless current_status == 'completed'
            status_items << {
              type: :form,
              text: t('actions.mark_complete'),
              url: toggle_status_audit_path(@audit_session),
              method: :patch,
              data: { turbo_method: :patch, turbo_frame: "_top" },
              icon_path: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
              hidden_field: { name: 'status', value: 'completed' },
              hover_color: 'success'
            }
          end
        %>

        <%= render DropdownButtonComponent.new(
          text: content_tag(:span, class: "inline-flex items-center") do
            concat(content_tag(:svg, class: "-ml-1 mr-2 h-4 w-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24") do
              case @audit_session.status
              when 'draft'
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />'.html_safe
              when 'active'
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />'.html_safe
              when 'completed'
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'.html_safe
              else
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />'.html_safe
              end
            end)
            concat(content_tag(:span, @audit_session.status.titleize, class: "hidden sm:inline"))
            concat(content_tag(:span, @audit_session.status.titleize, class: "sm:hidden"))
          end.html_safe,
          variant: case @audit_session.status
                  when 'draft' then :secondary
                  when 'active' then :primary
                  when 'completed' then :success
                  else :secondary
                  end,
          items: status_items,
          class: "flex-shrink-0"
        ) %>
        <%= form_with url: audit_path(@audit_session), method: :delete, local: true, data: { turbo_method: :delete, turbo_confirm: t('confirmations.delete_audit') }, class: "inline-block" do |form| %>
          <%= render ButtonComponent.new(
            text: content_tag(:span, class: "inline-flex items-center") do
              concat(content_tag(:svg, class: "-ml-1 mr-2 h-4 w-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24") do
                content_tag(:path, "", "stroke-linecap": "round", "stroke-linejoin": "round", "stroke-width": "2", d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16")
              end)
              concat(t('buttons.delete'))
            end.html_safe,
            type: :submit,
            variant: :danger,
            include_flex: true,
            class: "flex-shrink-0"
          ) %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Status Cards -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 mt-8" aria-live="polite" aria-atomic="false">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <!-- Heroicons: user-group -->
          <svg class="h-8 w-8 text-blue-800" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true" data-slot="icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= t('common.total_members') %></p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= @team_members.count %></p>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <!-- Heroicons: check-badge -->
          <svg class="h-8 w-8 text-vads-success" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true" data-slot="icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= t('common.validated') %></p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= @team_members.validated.count %></p>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <!-- Heroicons: wrench-screwdriver -->
          <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true" data-slot="icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= t('common.maintainers') %></p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= @audit_session.maintainer_members.count %></p>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <!-- Heroicons: chart-pie -->
          <svg class="h-8 w-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" data-slot="icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= t('common.progress') %></p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= @progress.round %>%</p>
        </div>
      </div>
    </div>

  </div>


  <!-- Team Members Table -->
  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
    <div class="flow-root">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <caption class="sr-only"><%= t('accessibility.team_members_table', audit_name: @audit_session.name) %></caption>
        <thead>
          <tr>
            <th scope="col" class="py-3.5 pr-3 pl-4 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider sm:pl-6">
              <%= t('common.member') %>
            </th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <%= t('common.role') %>
            </th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <%= t('common.status') %>
            </th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <%= t('common.issues') %>
            </th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <%= t('common.first_seen') %>
            </th>
            <th scope="col" class="px-3 py-3.5 pr-4 sm:pr-6 text-left text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              <%= t('common.last_seen') %>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          <% @team_members.each do |member| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="py-4 pr-3 pl-4 text-sm font-medium whitespace-nowrap sm:pl-6">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <img class="h-10 w-10 rounded-full" src="<%= member.avatar_url %>" alt="<%= member.display_name %>">
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                      <%= safe_github_link(member) %>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">@<%= member.github_login %></div>
                  </div>
                </div>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap">
                <div class="flex flex-col space-y-1">
                  <% if member.maintainer_role? %>
                    <%= render StatusBadgeComponent.new(status: "maintainer", class: "w-fit") %>
                  <% else %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 w-fit">
                      <%= t('status_badges.member') %>
                    </span>
                  <% end %>
                  <% if member.government_employee? %>
                    <%= render StatusBadgeComponent.new(status: "government", class: "w-fit") %>
                  <% end %>
                </div>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap">
                <%= form_with url: toggle_status_audit_member_path(member), method: :patch, local: true, data: { turbo_method: :patch }, class: "inline-block" do |form| %>
                  <%= button_tag type: :submit, class: "cursor-pointer border-0 bg-transparent p-0 hover:opacity-75 hover:scale-105 transition-all duration-150" do %>
                    <% if member.removed? %>
                      <%= render StatusBadgeComponent.new(status: "removed") %>
                    <% else %>
                      <%= render StatusBadgeComponent.new(status: member.validation_status) %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dark:text-gray-400">
                <% if member.team_member.issue_correlations.any? %>
                  <div data-controller="issue-list">
                    <!-- Summary view (first 2 issues) -->
                    <div data-issue-list-target="summary">
                      <% member.team_member.issue_correlations.order(issue_updated_at: :desc).limit(2).each do |issue| %>
                        <div class="mb-1 flex items-center gap-1">
                          <% if issue.resolved? %>
                            <!-- Heroicons: check-circle outline (purple for resolved) -->
                            <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                          <% else %>
                            <!-- Heroicons: exclamation-circle outline (green for open) -->
                            <svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                            </svg>
                          <% end %>
                          <%= link_to "##{issue.github_issue_number}", issue.github_issue_url,
                                      target: "_blank", "aria-label": t('accessibility.view_github_issue', number: issue.github_issue_number), class: "text-blue-800 dark:text-blue-600 hover:text-blue-700 dark:hover:text-blue-500" %>
                        </div>
                      <% end %>
                      <% if member.team_member.issue_correlations.count > 2 %>
                        <button
                          type="button"
                          class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline cursor-pointer"
                          data-action="click->issue-list#toggle"
                          data-issue-list-target="toggleButton"
                          data-expand-text="+<%= member.team_member.issue_correlations.count - 2 %> more"
                          data-collapse-text="Show less">
                          +<%= member.team_member.issue_correlations.count - 2 %> more
                        </button>
                      <% end %>
                    </div>

                    <!-- Expanded view (all issues) -->
                    <div data-issue-list-target="expanded" hidden>
                      <% member.team_member.issue_correlations.order(issue_updated_at: :desc).each do |issue| %>
                        <div class="mb-1 flex items-center gap-1">
                          <% if issue.resolved? %>
                            <!-- Heroicons: check-circle outline (purple for resolved) -->
                            <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                          <% else %>
                            <!-- Heroicons: exclamation-circle outline (green for open) -->
                            <svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                            </svg>
                          <% end %>
                          <%= link_to "##{issue.github_issue_number}", issue.github_issue_url,
                                      target: "_blank", "aria-label": t('accessibility.view_github_issue', number: issue.github_issue_number), class: "text-blue-800 dark:text-blue-600 hover:text-blue-700 dark:hover:text-blue-500" %>
                        </div>
                      <% end %>
                      <button
                        type="button"
                        class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline cursor-pointer"
                        data-action="click->issue-list#toggle"
                        data-issue-list-target="toggleButton"
                        data-expand-text="+<%= member.team_member.issue_correlations.count - 2 %> more"
                        data-collapse-text="Show less">
                        Show less
                      </button>
                    </div>
                  </div>
                <% else %>
                  <span class="text-gray-400 dark:text-gray-500"><%= t('common.no_issues') %></span>
                <% end %>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dark:text-gray-400">
                <% if member.team_member.first_seen_at %>
                  <%= time_ago_in_words(member.team_member.first_seen_at) %> ago
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dark:text-gray-400 pr-4 sm:pr-6">
                <% if member.team_member.last_seen_at %>
                  <%= time_ago_in_words(member.team_member.last_seen_at) %> ago
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
        </table>
      </div>
    </div>

    <% if @team_members.empty? %>
      <%= render EmptyStateComponent.new(
        title: t('empty_states.no_team_members'),
        message: t('empty_states.sync_to_get_started'),
        icon_name: :members
      ) %>
    <% end %>
  </div>
  </div>

  <!-- Notes Section -->
  <% if @audit_session.notes.present? %>
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700 mt-8">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white"><%= t('common.notes') %></h3>
      </div>
      <div class="px-6 py-4">
        <div class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line"><%= @audit_session.notes %></div>
      </div>
    </div>
  <% end %>
      </div>
    </main>
  </div>
</div>
